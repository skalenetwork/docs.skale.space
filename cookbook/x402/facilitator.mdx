---
title: "Running a Facilitator on SKALE"
description: "Set up an x402 facilitator service for payment processing"
---

A facilitator in the x402 protocol is an HTTP service that processes payments and provides settlement. It exposes `/accepts` and `/settle` endpoints that work with x402 middleware to handle payment flows.

## Prerequisites

- Understanding of x402 protocol
- Node.js and npm installed
- A SKALE Chain endpoint
- Understanding of HTTP services
- Familiarity with TypeScript/JavaScript

## Overview

A facilitator service:

1. Exposes `/accepts` endpoint - Returns payment requirements for resources
2. Exposes `/settle` endpoint - Validates and processes payment settlements
3. Handles payment verification
4. May charge fees for services

## Quick Start

Install the facilitator package:

```bash
npm install @faremeter/facilitator
```

## Basic Facilitator Service

Here's a simple facilitator service:

```typescript
import express from 'express';
import { createFacilitator } from '@faremeter/facilitator';

const app = express();
app.use(express.json());

const facilitator = createFacilitator({
  network: 'skale-base-sepolia',
  paymentHandlers: [
    {
      scheme: 'exact',
      network: 'skale-base-sepolia',
      handler: async (payment) => {
        // Verify and process payment
        // Return settlement result
        return { success: true };
      },
    },
  ],
});

// Mount facilitator routes
app.use('/facilitator', facilitator.router);

app.listen(3000, () => {
  console.log('Facilitator running on port 3000');
});
```

## Facilitator Endpoints

### `/accepts`

Returns payment requirements for a given resource:

```typescript
app.get('/accepts', async (req, res) => {
  const { resource } = req.query;
  
  const requirements = {
    accepts: [
      {
        scheme: 'exact',
        network: 'skale-base-sepolia',
        maxAmountRequired: '1.5',
        description: 'SKALE USDC payment',
      },
    ],
  };
  
  res.json(requirements);
});
```

### `/settle`

Validates and processes payment settlements:

```typescript
app.post('/settle', async (req, res) => {
  const payment = req.body;
  
  try {
    // Validate payment signature
    const isValid = await validatePayment(payment);
    
    if (!isValid) {
      return res.status(400).json({ error: 'Invalid payment' });
    }
    
    // Process settlement
    const result = await processSettlement(payment);
    
    res.json({ success: true, result });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
```

## Payment Handler

Implement payment handlers for different schemes:

```typescript
import { createPaymentHandler } from '@faremeter/payment-evm';

const paymentHandler = createPaymentHandler({
  network: 'skale-base-sepolia',
  rpcUrl: 'YOUR_SKALE_RPC_URL',
  verifyPayment: async (payment) => {
    // Verify payment on-chain
    // Check signature, amount, expiration, etc.
    return true;
  },
  settlePayment: async (payment) => {
    // Execute settlement
    // Transfer tokens, record payment, etc.
    return { txHash: '0x...' };
  },
});
```

## Fee Management

Add fee calculation to your facilitator:

```typescript
const facilitator = createFacilitator({
  network: 'skale-base-sepolia',
  feeBasisPoints: 100, // 1% fee
  paymentHandlers: [paymentHandler],
  calculateFee: (amount) => {
    return (amount * 100) / 10000; // 1% fee
  },
});
```

## Error Handling

Handle payment errors gracefully:

```typescript
app.post('/settle', async (req, res) => {
  try {
    const result = await facilitator.settle(req.body);
    res.json(result);
  } catch (error) {
    if (error.code === 'INVALID_SIGNATURE') {
      return res.status(400).json({ error: 'Invalid payment signature' });
    }
    if (error.code === 'EXPIRED_PAYMENT') {
      return res.status(400).json({ error: 'Payment expired' });
    }
    if (error.code === 'INSUFFICIENT_AMOUNT') {
      return res.status(400).json({ error: 'Insufficient payment amount' });
    }
    res.status(500).json({ error: 'Internal server error' });
  }
});
```

## Best Practices

1. **Validate Payments**: Always verify payment signatures and amounts
2. **Error Handling**: Provide clear error messages for failed settlements
3. **Fee Transparency**: Clearly communicate fees to users
4. **Security**: Use secure key management for payment verification
5. **Monitoring**: Set up monitoring and alerting for payment processing

## Security Considerations

- Validate all payment signatures
- Check payment expiration times
- Verify payment amounts match requirements
- Use secure key storage
- Implement rate limiting
- Monitor for suspicious activity

## Next Steps

- [Become an x402 Seller](/cookbook/x402/become-an-x402-seller)
- [Accepting x402 Payments](/cookbook/x402/accepting-payments)
- [Buying with x402](/cookbook/x402/buying)

## Resources

- [Corbits/Faremeter Facilitator](https://docs.corbits.dev/api/reference/facilitator/overview)
- [x402 Examples Repository](https://github.com/TheGreatAxios/x402-examples)
- [Coinbase x402 SDK](https://github.com/coinbase/x402)
